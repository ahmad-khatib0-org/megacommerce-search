# Multi-stage build for Rust search service
FROM rust:alpine AS builder

WORKDIR /app

# 1. Install ALL build dependencies (INCLUDING BASH!)
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    build-base \
    postgresql-dev \
    curl-dev \
    python3 \
    librdkafka-dev \
    zlib-dev \
    zstd-dev \
    lz4-dev \
    cmake \
    g++ \
    bash

# 2. Copy dependency files
COPY Cargo.toml Cargo.lock ./

# 3. Create dummy src to cache dependencies
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// dummy" > src/lib.rs

# 4. Download and cache dependencies
RUN cargo fetch --locked

# 5. Copy source code
COPY .sqlx ./.sqlx
COPY src ./src
COPY config.dev.yaml ./

# 6. Build (WITHOUT musl target for rdkafka)
RUN cargo build --release && \
    strip target/release/megacommerce-search

# Stage 2: Runtime
FROM alpine:latest
WORKDIR /app

# Install runtime dependencies (rdkafka needs glibc, not musl)
RUN apk add --no-cache \
    libgcc \
    postgresql-client \
    ca-certificates \
    librdkafka \
    zstd-libs \
    lz4-libs \
    # For dynamic linking (rdkafka needs glibc)
    libc6-compat

COPY --from=builder /app/target/release/megacommerce-search /usr/local/bin/
COPY --from=builder /app/config.dev.yaml ./

EXPOSE 50057

CMD ["/usr/local/bin/megacommerce-search"]
