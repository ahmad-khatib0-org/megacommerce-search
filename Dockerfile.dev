# Multi-stage build for Rust search service
FROM rust:alpine AS builder

WORKDIR /app

# 1. Install ALL build dependencies (INCLUDING STATIC LIBRARIES!)
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    openssl-libs-static \
    build-base \
    postgresql-dev \
    curl-dev \
    python3 \
    librdkafka-dev \
    zlib-dev \
    zlib-static \
    zstd-dev \
    lz4-dev \
    cmake \
    g++ \
    bash

# 2. Copy dependency files
COPY Cargo.toml Cargo.lock ./

# 3. Create dummy src to cache dependencies
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// dummy" > src/lib.rs

# 4. Download and cache dependencies
RUN cargo fetch --locked

# 5. Copy source code
COPY .sqlx ./.sqlx
COPY src ./src
COPY config.dev.yaml ./

# 6. Build WITH musl target (now we have static libs!)
RUN cargo build --release --target x86_64-unknown-linux-musl && \
    strip target/x86_64-unknown-linux-musl/release/megacommerce-search

# Stage 2: Runtime
FROM alpine:latest
WORKDIR /app

# Install runtime dependencies (now binary is statically linked, needs fewer libs)
RUN apk add --no-cache \
    libgcc \
    postgresql-client \
    ca-certificates

COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/megacommerce-search /usr/local/bin/
COPY --from=builder /app/config.dev.yaml ./

EXPOSE 50057

CMD ["/usr/local/bin/megacommerce-search"]
