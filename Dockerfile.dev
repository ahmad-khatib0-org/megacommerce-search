# Multi-stage build for Rust search service
FROM rust:alpine AS builder

WORKDIR /app

# 1. FIRST: Install ALL build dependencies (500MB layer - cached unless package list changes)
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    build-base \
    postgresql-dev \
    curl-dev \
    python3 \
    librdkafka-dev \
    zlib-dev \
    zstd-dev \
    lz4-dev \
    cmake \
    g++

# 2. Copy dependency files (changes rarely)
COPY Cargo.toml Cargo.lock ./

# 3. Create dummy src to cache dependencies
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// dummy" > src/lib.rs

# 4. Download and cache dependencies (uses Cargo.lock)
RUN cargo fetch --locked

# 5. NOW copy source code (changes often)
COPY .sqlx ./.sqlx
COPY src ./src
COPY config.dev.yaml ./

# 6. Build (only recompiles changed source)
RUN cargo build --release --target x86_64-unknown-linux-musl && \
    strip target/x86_64-unknown-linux-musl/release/megacommerce-search

# Stage 2: Runtime
FROM alpine:latest
WORKDIR /app
RUN apk add --no-cache libgcc postgresql-client ca-certificates librdkafka zstd-libs lz4-libs
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/megacommerce-search /usr/local/bin/
COPY --from=builder /app/config.dev.yaml ./
EXPOSE 50057
CMD ["/usr/local/bin/megacommerce-search"]
