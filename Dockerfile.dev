# Multi-stage build for Rust search service
FROM rust:1.88-slim-bookworm AS base

WORKDIR /app

ENV ENV=dev \
    CARGO_NET_GIT_FETCH_WITH_CLI=true

# Install system dependencies - ADD build-essential for C++ compiler (rdkafka)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libssl-dev \
    postgresql-client \
    curl \
    python3 \
    && rm -rf /var/lib/apt/lists/*

# Dependencies stage
FROM base AS deps

COPY .sqlx ./.sqlx
COPY Cargo.toml Cargo.lock ./
COPY src ./src

RUN cargo build --release 2>&1 | grep -v "warning:" || true

# Development stage
FROM base AS dev

COPY Cargo.toml Cargo.lock ./
COPY --from=deps /app/target ./target
COPY src ./src
COPY config.dev.yaml .

RUN cargo install cargo-watch

EXPOSE 50057

CMD ["cargo", "watch", "-x", "run"]
